import os
import random
from datetime import date, datetime
import json

import matplotlib.pyplot as plt

from .retrieve_data import input_df, retrieve_series, retrieve_data
from .clustering.clustering import run_clustering
from .outputs.outputs import write_clustering_results
from.elbow import run_elbow_save_config
from .silhouette import silhouette
from .save import save_general_config, save_duration_config

from . import settings

# from.loop import (
#     NORM_MODE,
#     FOURIER
# )




def only_clustering(timeseries):

    """
    Create a filtered and formated dataset according to settings and run clustering
    """

    clustering_start = datetime.now()
    print('{} Starting clustering'.format(clustering_start))
    tskm = run_clustering(timeseries, **settings.TSKM_ARGS)
    clustering_end = datetime.now()
    print('{} Finished clustering'.format(clustering_end))
    clustering_duration = int((clustering_end - clustering_start).total_seconds())
    print('Clustering duration: {}s'.format(clustering_duration))
    print()

    return tskm, clustering_duration

def run_clustering_results(initial_df, tskm):

    normalized_cpu_df = input_df(initial_df)

    # Convert output directory to absolute path
    results_directory = os.path.abspath(settings.RESULTS_DIRECTORY)

    # Create output directory if not existing
    if not os.path.isdir(results_directory):
        os.makedirs(results_directory)

    results_start = datetime.now()
    print('{} Writing results to {}'.format(results_start, results_directory))
    write_clustering_results(
        initial_df,
        normalized_cpu_df,
        tskm,
        results_directory
    )
    results_end = datetime.now()
    print('{} Results written'.format(results_end))
    results_duration = int((results_end - results_start).total_seconds())
    print('Results duration: {}s'.format(results_duration))
    print()   

    return results_duration 


def run_clustering_save_config(save_config=True):
    '''
       retrieve data, run clustering and save silhouette
    '''
    # start = datetime.now()
    
    # initial_df, dataset_duration = retrieve_data()
    # series_matrix = retrieve_series(initial_df)
    # tskm, clustering_duration = only_clustering(series_matrix)
    # silhouette(series_matrix, tskm.labels_)

    # if (save_config):
    #     #write results
    #     results_duration = run_clustering_results(initial_df,tskm)
    #     #save config
    #     save_general_config(settings.RESULTS_DIRECTORY)

    #     end = datetime.now()
    #     duration = int((end - start).total_seconds())

    #     #save duration config
    #     save_duration_config(settings.RESULTS_DIRECTORY,start,
    #                         dataset_duration,clustering_duration,
    #                         results_duration,duration)
    # else:
    #     end = datetime.now()
    #     duration = int((end - start).total_seconds())

    # print('Finished')
    # print('Total duration: {}s'.format(duration))

    print(
        settings.TSKM_ARGS['n_clusters'],
        settings.TSKM_ARGS['metric'],
        settings.TSKM_ARGS['n_init'],
        settings.NORM_MODE,
        settings.FOURIER
    )        


# Run as program
if __name__ == '__main__':
    # run_elbow_save_config()
    run_clustering_save_config(save_config=True)
   
