
import random
from datetime import date, datetime

from .data_source.db_query import get_cpu_query
from .data_source.dataframe import db_to_df, hosts_timeseries, normalized_cpu_threshold_df, hosts_timeseries_for_fourier
from .fourier import time_freq_dataset

from .settings import (
    DB_QUERY_ARGS,
    NUMBER_OF_RANDOM_MACHINES,
    CPU_THRESHOLD_NORMALIZATION,
    INTERVAL_SECONDS,
    FOURIER
)

def retrieve_data():
    '''
    Retrieves data from dataset as in settings 
    and time taken to permor retrieval
    '''

    dataset_start = datetime.now()
    print('{} Fetching dataset'.format(dataset_start))

    # DB query
    query = get_cpu_query(
        **DB_QUERY_ARGS
    )
    records = query.all()

    # Convert DB records to dataframe
    initial_df = db_to_df(records)

    dataset_end = datetime.now()
    print('{} Dataset fetched'.format(dataset_end))
    dataset_duration = int((dataset_end - dataset_start).total_seconds())
    print('Dataset duration: {}s'.format(dataset_duration))
    print()

    return initial_df, dataset_duration
    

def input_df(initial_df):
    '''
    Given the retrieved data from database, filters and or 
    transofrm data as it will be used in clustering
    '''

    # Select a number of random machines if specified
    if NUMBER_OF_RANDOM_MACHINES:
        machines = random.sample(
            list(initial_df.hostname.unique()),
            k=NUMBER_OF_RANDOM_MACHINES
        )
        initial_df = initial_df[initial_df.hostname.isin(machines)]

    # Normalize CPU values against specified thresholds if specified
    if CPU_THRESHOLD_NORMALIZATION:
        normalized_cpu_df = normalized_cpu_threshold_df(
            initial_df,
            CPU_THRESHOLD_NORMALIZATION
        )
    else:
        normalized_cpu_df = initial_df
    
    return normalized_cpu_df

def retrieve_series(initial_df):

    normalized_cpu_df = input_df(initial_df)

    if (FOURIER):
        #get timeseries in nice format for FourierT
        timeseries = hosts_timeseries_for_fourier(normalized_cpu_df)
        #apply Fourier transform
        freq, timeseries = time_freq_dataset(timeseries)
        print("Fourier Series Computed")
    else:
        # Get tslearn compatible timeseries, with missing dates
        # filled automatically
        # Increase time series interval if specified
        timeseries = hosts_timeseries(
            normalized_cpu_df,
            interval_seconds=INTERVAL_SECONDS
        )
        print("Time Series Computed")

    return timeseries

