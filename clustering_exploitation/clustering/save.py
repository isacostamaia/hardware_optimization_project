import os
import json
from datetime import date, datetime 


from .settings import (
    DB_QUERY_ARGS,
    NUMBER_OF_RANDOM_MACHINES,
    CPU_THRESHOLD_NORMALIZATION,
    INTERVAL_SECONDS,
    TSKM_ARGS,
    CLUSTERS_RANGE,
    NORM_MODE,
    FOURIER
)

def save_general_config(directory):
    # Write summary to output directory
    summary = {
        'start_date': datetime.now(),
        'settings': {
            'DB_QUERY_ARGS': DB_QUERY_ARGS,
            'NUMBER_OF_RANDOM_MACHINES': NUMBER_OF_RANDOM_MACHINES,
            'CPU_THRESHOLD_NORMALIZATION': CPU_THRESHOLD_NORMALIZATION,
            'INTERVAL_SECONDS': INTERVAL_SECONDS,
            'TSKM_ARGS': TSKM_ARGS,
            'CLUSTERS_RANGE': CLUSTERS_RANGE,
            'NORM_MODE': NORM_MODE,
            'FOURIER': FOURIER,
        },

    }

    # Convert output directory to elbow path
    results_directory = os.path.abspath(directory)

    # Create output directory if not existing
    if not os.path.isdir(results_directory):
        os.makedirs(results_directory)

    with open(os.path.join(results_directory, 'summary.json'), 'w') as summary_file:
        json.dump(summary, summary_file, sort_keys=False, indent=4, default=_json_default)

def save_duration_config(directory,start,dataset_duration,clustering_duration,results_duration,duration):
    # Write summary to output directory
    summary = {
        'start_date': start,
        'durations': {
            'dataset': dataset_duration,
            'clustering': clustering_duration,
            'results': results_duration,
            'total': duration,
        }
    }
    # Convert output directory to elbow path
    results_directory = os.path.abspath(directory)

    # Create output directory if not existing
    if not os.path.isdir(results_directory):
        os.makedirs(results_directory)

    with open(os.path.join(results_directory, 'summary_duration.json'), 'w') as summary_file:
        json.dump(summary, summary_file, sort_keys=False, indent=4, default=_json_default)


def _json_default(obj):
    """
    Convert datetimes to string for json export
    """
    if isinstance(obj, (date, datetime)):
        return obj.isoformat()