"""
Does Elbow Method
"""
import os

import matplotlib.pyplot as plt
from kneed import KneeLocator

from .retrieve_data import retrieve_series, retrieve_data
from .save import save_general_config
from .clustering.clustering import run_clustering


from .settings import (

    TSKM_ARGS,
    ELBOW_DIRECTORY,
    CLUSTERS_RANGE

)


def elbow():

    """
        Create elbow plot doing clusters following dic_settings parameters,
        but in a range of clusters given by clusters_range.
        clusters_range given as (2,10)
    """
    global TSKM_ARGS

    initial_df, dataset_duration = retrieve_data()
    series_matrix = retrieve_series(initial_df)

    inertia_list = []
    K = range(CLUSTERS_RANGE[0],CLUSTERS_RANGE[1])
    for i in K:
        # dic_settings['n_clusters'] = i
        TSKM_ARGS['n_clusters'] = i
        tskm_result = run_clustering(series_matrix)
        # y_pred = tskm_result.labels_
        inertia_list.append(tskm_result.inertia_)

    plt.figure(figsize=(16,8))
    plt.plot(K, inertia_list, 'bx-')
    plt.xlabel('k')
    plt.ylabel('Distortion')
    plt.title('The Elbow Method showing the optimal k')    
    
    try:
        #knee
        kn = KneeLocator(K, inertia_list, curve='convex', direction='decreasing')
        
        #plot knee 
        plt.vlines(kn.knee, plt.ylim()[0], plt.ylim()[1], linestyles='dashed')
    except:
        print('No elbow found')



    # Convert output directory to elbow path
    results_directory = os.path.abspath(ELBOW_DIRECTORY)

    # Create output directory if not existing
    if not os.path.isdir(results_directory):
        os.makedirs(results_directory)


    #save figure
    plt.savefig('{0}/.elbow_plot.png'.format(results_directory))



def run_elbow_save_config():
    '''
        run elbow and save configs
    '''

    print('Making Elbow...')
    elbow()
    print('Saving Configs...')
    save_general_config(ELBOW_DIRECTORY)